---
title: "GAMM"
output: html_document
---

```{r}
# Load necessary library
require(readr)
require(ggplot2)
require(lme4)
require(dplyr)
require(mgcv)

# Read CSV data
#histidine <- read_csv("Dataset_input/Covid/rep_raw/histidine.csv")
#histidine <- read_csv("Dataset_input/Covid/MG1655/MG1655_mild_severe_transform.csv")
histidine <- read_csv("Dataset_input/MG1655/MG1655all.csv")
unique(histidine$Case)
histidine <- histidine %>% 
  filter(!Case %in% c("M")) %>% # remove negative control
  group_by(Time, Individual, Case) %>%
  summarise(OD = mean(OD, na.rm = TRUE), .groups = "drop")
#histidine <- histidine %>% filter(Mutant == "Deoxycytidine")
#histidine = histidine %>% filter(Time > 0)
# Check the structure of the data
str(histidine)
unique(histidine$Individual)
histidine$Individual = as.factor(histidine$Individual)
histidine$Case = as.factor(histidine$Case)
```

```{r}
# test autocorrelation
model1 <- gamm(OD ~ s(Time, by = Case) + Case, 
               data = histidine,
               random = list(Individual = ~Time),
               select = TRUE, 
               method = "REML")

model2 <- gamm(OD ~ s(Time, by = Case)+Case,
               random = list(Individual = ~Time), 
               data = histidine, 
               correlation=corARMA(form=~1|Individual, p = 1), # included correlation
               select = TRUE, 
               method = "REML")

anova(model1$lme,model2$lme)
```

```{r}
summary(model2$gam)
```

```{r}
# plot the fitted model

fitted_vals <- fitted(model2$gam)


fig <- ggplot(histidine, aes(Time, OD, shape = Case)) +
  stat_summary(fun.data = mean_se, geom = "pointrange") +
  stat_summary(aes(y = fitted_vals, linetype = Case, color = Case),
               fun = mean, geom = "line", size = 1.5) +
  scale_x_continuous(breaks = 1:20) +
  scale_color_manual(values = c("red", "blue")) +
  labs(
    x = "Time (hours)",
    y = "OD Value",
    title = "GAMM Model Fit"
  ) +
  theme_minimal()
print(fig)
```



